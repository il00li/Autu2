import telebot
from telebot import types
import logging
import time
from pyrogram import Client
import asyncio

# ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª
TOKEN = "8247037355:AAH2rRm9PJCXqcVISS8g-EL1lv3tvQTXFys"
API_ID = 23656977
API_HASH = "49d3f43531a92b3f5bc403766313ca1e"

bot = telebot.TeleBot(TOKEN)

# Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
class UserState:
    LOGIN_PHONE = 1
    LOGIN_CODE = 2
    SET_MESSAGE = 3
    SET_GROUPS = 4
    SET_COUNT = 5
    SET_INTERVAL = 6

# ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
user_data = {}

# Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ØªÙˆÙ‚ÙŠØª
TIMING_OPTIONS = {
    "2 Ø¯Ù‚Ø§Ø¦Ù‚": 120,
    "5 Ø¯Ù‚Ø§Ø¦Ù‚": 300,
    "10 Ø¯Ù‚Ø§Ø¦Ù‚": 600,
    "15 Ø¯Ù‚Ø§Ø¦Ù‚": 900
}

# Ø¥Ù†Ø´Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
def main_menu_keyboard(user_id=None):
    markup = types.InlineKeyboardMarkup()
    
    # Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯
    if user_id not in user_data or not user_data[user_id].get('logged_in'):
        markup.add(types.InlineKeyboardButton("ğŸŒ± 1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„", callback_data='login'))
    else:
        markup.add(types.InlineKeyboardButton("ğŸ“ 2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø©", callback_data='set_message'))
        markup.add(types.InlineKeyboardButton("ğŸŒ¿ 3. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª", callback_data='set_groups'))
        markup.add(types.InlineKeyboardButton("ğŸ€ 4. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø¯Ø¯", callback_data='set_count'))
        markup.add(types.InlineKeyboardButton("â± 5. Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª", callback_data='set_interval'))
    
    # Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    markup.row(
        types.InlineKeyboardButton("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø±", callback_data='start_posting'),
        types.InlineKeyboardButton("ğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø´Ø±", callback_data='stop_posting')
    )
    markup.add(types.InlineKeyboardButton("â„¹ï¸ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª", callback_data='bot_status'))
    
    return markup

# Ù„ÙˆØ­Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆÙ‚ÙŠØª
def timing_keyboard():
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("â± ÙƒÙ„ 2 Ø¯Ù‚Ø§Ø¦Ù‚", callback_data='interval_120'))
    markup.add(types.InlineKeyboardButton("â± ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚", callback_data='interval_300'))
    markup.add(types.InlineKeyboardButton("â± ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚", callback_data='interval_600'))
    markup.add(types.InlineKeyboardButton("â± ÙƒÙ„ 15 Ø¯Ù‚Ø§Ø¦Ù‚", callback_data='interval_900'))
    markup.add(types.InlineKeyboardButton("ğŸ”™ Ø±Ø¬ÙˆØ¹", callback_data='back_to_main'))
    return markup

# Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª
@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    if user_id not in user_data:
        user_data[user_id] = {}
    
    bot.send_message(
        message.chat.id,
        "ğŸ‘‹ **Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…!**\n\n"
        "ğŸŒ¿ ÙŠØ±Ø¬Ù‰ Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨:\n"
        "1. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø­Ø³Ø§Ø¨Ùƒ\n"
        "2. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±Ø³Ø§Ù„Ø©\n"
        "3. ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª\n"
        "4. ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª\n"
        "5. Ø¶Ø¨Ø· ØªÙˆÙ‚ÙŠØª Ø§Ù„Ù†Ø´Ø±\n\n"
        "Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„Ø¨Ø¯Ø¡:",
        reply_markup=main_menu_keyboard(user_id),
        parse_mode='Markdown'
    )

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±
@bot.callback_query_handler(func=lambda call: True)
def handle_buttons(call):
    user_id = call.from_user.id
    chat_id = call.message.chat.id
    
    try:
        if call.data == 'login':
            msg = bot.send_message(
                chat_id,
                "ğŸ“± **Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ Ù…Ø¹ Ø±Ù…Ø² Ø§Ù„Ø¯ÙˆÙ„Ø©**\n"
                "Ù…Ø«Ø§Ù„: +201234567890\n\n"
                "ğŸ›‘ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙ‚Ø· Ù„Ù„Ù†Ø´Ø±",
                parse_mode='Markdown'
            )
            bot.register_next_step_handler(msg, process_phone_step)
            
        elif call.data == 'set_message':
            msg = bot.send_message(
                chat_id,
                "ğŸ“ **Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ù†Ø´Ø±Ù‡Ø§**\n"
                "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ†Ø³ÙŠÙ‚ Markdown",
                parse_mode='Markdown'
            )
            bot.register_next_step_handler(msg, process_message_step)
            
        elif call.data == 'set_interval':
            bot.edit_message_text(
                "â± **Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© Ø¨ÙŠÙ† Ø§Ù„Ù†Ø´Ø±Ø§Øª:**",
                chat_id,
                call.message.message_id,
                reply_markup=timing_keyboard()
            )
            
        elif call.data.startswith('interval_'):
            interval = int(call.data.split('_')[1])
            user_data[user_id]['interval'] = interval
            bot.send_message(
                chat_id,
                f"âœ… ØªÙ… Ø¶Ø¨Ø· Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø¹Ù„Ù‰ ÙƒÙ„ {interval//60} Ø¯Ù‚Ø§Ø¦Ù‚",
                reply_markup=main_menu_keyboard(user_id)
            )
            
        elif call.data == 'start_posting':
            if validate_user_settings(user_id):
                start_auto_posting(user_id, chat_id)
            else:
                bot.answer_callback_query(
                    call.id,
                    "âŒ ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ø£ÙˆÙ„Ø§Ù‹",
                    show_alert=True
                )
                
        elif call.data == 'bot_status':
            show_bot_status(user_id, call)
            
        elif call.data == 'back_to_main':
            bot.edit_message_text(
                "ğŸŒ¿ **Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©**",
                chat_id,
                call.message.message_id,
                reply_markup=main_menu_keyboard(user_id)
            )
            
    except Exception as e:
        logger.error(f"Error in handle_buttons: {e}")
        bot.answer_callback_query(call.id, "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ù…Ø§!")

# ØªØ£ÙƒÙŠØ¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
def validate_user_settings(user_id):
    required = ['logged_in', 'message', 'groups', 'count', 'interval']
    return all(key in user_data.get(user_id, {}) for key in required)

# Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª
def show_bot_status(user_id, call):
    status = "â„¹ï¸ **Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆØª:**\n\n"
    
    if user_id in user_data:
        data = user_data[user_id]
        status += f"ğŸ”¹ Ø§Ù„Ø­Ø³Ø§Ø¨: {'âœ… Ù…Ø³Ø¬Ù„' if data.get('logged_in') else 'âŒ ØºÙŠØ± Ù…Ø³Ø¬Ù„'}\n"
        status += f"ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©: {'âœ… Ù…Ø¹ÙŠÙ†Ø©' if 'message' in data else 'âŒ ØºÙŠØ± Ù…Ø¹ÙŠÙ†Ø©'}\n"
        status += f"ğŸŒ¿ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: {len(data.get('groups', []))}\n"
        status += f"ğŸ€ Ø§Ù„Ø¹Ø¯Ø¯: {data.get('count', 'âŒ ØºÙŠØ± Ù…Ø¹ÙŠÙ†')}\n"
        status += f"â± Ø§Ù„ØªÙˆÙ‚ÙŠØª: ÙƒÙ„ {data.get('interval', 0)//60} Ø¯Ù‚Ø§Ø¦Ù‚\n"
    else:
        status += "âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª Ø¨Ø¹Ø¯"
    
    bot.answer_callback_query(call.id, status, show_alert=True)

# Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
def start_auto_posting(user_id, chat_id):
    data = user_data[user_id]
    bot.send_message(chat_id, "ğŸš€ Ø¨Ø¯Ø£ Ø§Ù„Ù†Ø´Ø± Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...")
    
    for i in range(data['count']):
        for group in data['groups']:
            try:
                # Ù‡Ù†Ø§ ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Pyrogram
                asyncio.run(send_via_pyrogram(user_id, group, data['message']))
                logger.info(f"ØªÙ… Ø§Ù„Ù†Ø´Ø± ÙÙŠ {group} (Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© {i+1})")
            except Exception as e:
                logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†Ø´Ø±: {e}")
        
        if i < data['count'] - 1:
            time.sleep(data['interval'])
    
    bot.send_message(chat_id, "âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ù†Ø´Ø±!")

# Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¹Ø¨Ø± Pyrogram
async def send_via_pyrogram(user_id, chat_id, text):
    client = Client(
        f"user_{user_id}",
        api_id=API_ID,
        api_hash=API_HASH,
        session_string=user_data[user_id]['session_string']
    )
    
    async with client:
        await client.send_message(chat_id, text)

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == '__main__':
    logger.info("Starting bot...")
    bot.infinity_polling()
